<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Remote & Hybrid Jobs Index</title>
  <meta name="description" content="Searchable roles aggregated from multiple job platforms worldwide.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <meta property="og:title" content="Remote & Hybrid Jobs Index">
  <meta property="og:description" content="Searchable roles aggregated from multiple job platforms worldwide.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://pedrororo.github.io/remote-jobs-index/">
  <meta property="og:image" content="https://pedrororo.github.io/remote-jobs-index/preview.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:site_name" content="Remote & Hybrid Jobs Index">
  <meta property="og:locale" content="en_US">
  <meta name="twitter:title" content="Remote & Hybrid Jobs Index">
  <meta name="twitter:description" content="Searchable roles aggregated from multiple job platforms worldwide.">
  <meta name="twitter:image" content="https://pedrororo.github.io/remote-jobs-index/preview.png">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-67RCVE3KLG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-67RCVE3KLG', { anonymize_ip: true });
  </script>

  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --secondary-color: #64748b;
      --success-color: #10b981;
      --background-color: #f8fafc;
      --card-background: #ffffff;
      --border-color: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --border-radius: 8px;
      --border-radius-lg: 12px;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--background-color);
      color: var(--text-primary);
      line-height: 1.6;
      font-size: 14px;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }

    .header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      color: white; padding: 40px 0; text-align: center; position: relative; overflow: hidden;
    }
    .header::before {
      content: '';
      position: absolute; top:0; left:0; right:0; bottom:0;
      background: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23ffffff" fill-opacity="0.1"><circle cx="30" cy="30" r="4"/></g></svg>') repeat;
      pointer-events: none;
    }
    .header-content { position: relative; z-index: 1; }
    .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; letter-spacing: -0.025em; }
    .header .subtitle { font-size: 1.1rem; font-weight: 300; opacity: 0.9; margin-bottom: 20px; }
    .header .stats { display:flex; justify-content:center; gap:30px; margin-bottom:20px; flex-wrap:wrap; }
    .stat-item { text-align:center; }
    .stat-number { font-size:2rem; font-weight:700; display:block; }
    .stat-label { font-size:0.9rem; opacity:0.8; }
    .header .curator { font-size: 0.95rem; opacity: 0.9; }
    .header .curator a { color:white; text-decoration: underline; font-weight:500; }

    .main-content { padding:30px 0; }

    .filters-section {
      background: var(--card-background);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      padding: 25px;
      margin-bottom: 30px;
    }
    .filters-header {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:20px; flex-wrap:wrap; gap:15px;
    }
    .filters-title { font-size: 1.25rem; font-weight:600; color:var(--text-primary); display:flex; align-items:center; gap:8px; }
    .filters-actions { display:flex; gap:10px; }

    .btn {
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 16px; border:none; border-radius: var(--border-radius);
      font-size:0.9rem; font-weight:500; cursor:pointer;
      transition: all 0.2s ease;
      background: var(--primary-color); color:white; text-decoration:none;
    }
    .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn-secondary { background: var(--secondary-color); }
    .btn-secondary:hover { background: #475569; }
    .btn-sm { padding:6px 12px; font-size:0.85rem; }

    .filters-bar {
      display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px;
    }
    .filter-item { flex:1; min-width:200px; max-width:280px; position:relative; }
    .filter-label { display:block; font-size:0.85rem; font-weight:500; color: var(--text-secondary); margin-bottom:6px; }
    .filter-input {
      width:100%; padding:10px 12px; border:1px solid var(--border-color);
      border-radius: var(--border-radius); font-size:0.9rem;
      background:white; cursor:pointer;
    }

    .selected-tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; min-height:32px; }
    .selected-tag {
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; background: var(--primary-color); color:white;
      border-radius:16px; font-size:0.8rem; font-weight:500;
    }
    .selected-tag .remove {
      cursor:pointer; opacity:0.85; font-weight:bold; font-size:12px;
      width:16px; height:16px; display:flex; align-items:center; justify-content:center;
      border-radius:50%; background: rgba(255,255,255,0.2);
      border: none;
      color: white;
    }
    .selected-tag .remove:hover { opacity:1; background: rgba(255,255,255,0.3); }

    .dropdown {
      position:absolute; top:100%; left:0; right:0;
      background:white; border:1px solid var(--border-color);
      border-radius: var(--border-radius);
      max-height:300px; overflow-y:auto;
      z-index:1000; box-shadow: var(--shadow-lg);
      display:none;
    }
    .dropdown.show { display:block; }
    .dropdown-header { padding:12px; border-bottom:1px solid var(--border-color); background: var(--background-color); }
    .dropdown-search { width:100%; padding:8px 10px; border:1px solid var(--border-color); border-radius:6px; font-size:0.85rem; }
    .dropdown-list { max-height:200px; overflow-y:auto; }
    .dropdown-item {
      padding:10px 12px; cursor:pointer; font-size:0.9rem;
      transition: background-color 0.15s ease;
      border-bottom: 1px solid #f8f9fa;
      display:flex; align-items:center; gap:8px;
    }
    .dropdown-item:hover { background: var(--background-color); }
    .dropdown-item.selected { background: var(--primary-color); color:white; }
    .dropdown-item .checkbox {
      width:16px; height:16px; border:2px solid var(--border-color);
      border-radius:3px; display:flex; align-items:center; justify-content:center; font-size:10px; flex-shrink:0;
    }
    .dropdown-item.selected .checkbox { border-color:white; background:white; color: var(--primary-color); }
    .dropdown-item .item-text { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .dropdown-item .item-count { font-size:0.8rem; opacity:0.7; flex-shrink:0; }

    .results-section {
      background: var(--card-background);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      overflow:hidden;
    }
    .results-header {
      display:flex; justify-content:space-between; align-items:center;
      padding:20px 25px; border-bottom:1px solid var(--border-color);
      flex-wrap:wrap; gap:15px;
    }
    .results-count { font-size:1rem; color: var(--text-secondary); display:flex; align-items:center; gap:8px; }

    .table-container { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; }
    th {
      background: var(--background-color);
      padding:16px 12px; text-align:left;
      font-weight:600; font-size:0.85rem;
      color: var(--text-secondary);
      text-transform:uppercase; letter-spacing:0.05em;
      border-bottom: 1px solid var(--border-color);
      position: sticky; top:0; z-index:10;
    }
    td { padding:16px 12px; border-bottom:1px solid var(--border-color); vertical-align:top; }
    tr:hover { background: var(--background-color); }

    .job-title { font-weight:600; color: var(--text-primary); margin-bottom:4px; line-height:1.4; }

    .meta-tag {
      display:inline-flex; align-items:center; gap:4px;
      padding:2px 8px; background: var(--background-color);
      color: var(--text-secondary); border-radius:12px;
      font-size:0.75rem; font-weight:500;
    }

    .meta-tag.posted {
      background: linear-gradient(135deg, #f3e8ff 0%, #e0e7ff 100%);
      color:#7c3aed; border: 1px solid #ddd6fe;
      cursor:pointer; transition: all 0.2s ease;
      position: relative;
    }
    .meta-tag.posted:hover { transform: translateY(-1px); }

    .meta-tag.posted.recent {
      background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%);
      color:#166534; border:1px solid #bbf7d0;
    }
    .meta-tag.posted.old {
      background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
      color:#92400e; border:1px solid #fde68a;
    }

    .posted-expanded {
      position:absolute; top:100%; left:0;
      background:white; border:1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding:12px; box-shadow: var(--shadow-lg);
      z-index:1000; min-width:200px; margin-top:4px;
      display:none;
    }
    .posted-expanded.show { display:block; }

    .apply-link {
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 16px; background: var(--success-color);
      color:white; text-decoration:none;
      border-radius: var(--border-radius);
      font-weight:500; font-size:0.85rem; transition: all 0.2s ease;
    }
    .apply-link:hover { background:#059669; transform: translateY(-1px); color:white; text-decoration:none; }

    .load-more-container { padding:30px; text-align:center; border-top: 1px solid var(--border-color); }
    .spinner {
      border:2px solid var(--border-color);
      border-top:2px solid var(--primary-color);
      border-radius:50%; width:20px; height:20px;
      animation: spin 1s linear infinite; display:inline-block; margin-right:8px;
    }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

    .no-results { text-align:center; padding:60px 20px; color: var(--text-secondary); }
    .no-results i { font-size:3rem; margin-bottom:16px; opacity:0.5; }
    .no-results h3 { font-size:1.25rem; margin-bottom:8px; color: var(--text-primary); }
    .no-results p { font-size:0.95rem; }

    .sr-only {
      position:absolute; width:1px; height:1px;
      padding:0; margin:-1px; overflow:hidden; clip: rect(0,0,0,0);
      white-space:nowrap; border:0;
    }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(10px); }
      to { opacity:1; transform: translateY(0); }
    }
  </style>
</head>

<body>
<header class="header">
  <div class="container">
    <div class="header-content">
      <h1><i class="fas fa-briefcase"></i> Remote & Hybrid Jobs Index</h1>
      <p class="subtitle">Searchable roles aggregated from multiple job platforms worldwide</p>

      <div class="stats">
        <div class="stat-item">
          <span class="stat-number" id="statTotalJobs">—</span>
          <span class="stat-label">Active Positions</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="statCompanies">—</span>
          <span class="stat-label">Companies</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="statLocations">—</span>
          <span class="stat-label">Locations</span>
        </div>
      </div>

      <p class="curator">
        <i class="fas fa-user-tie"></i>
        Curated by <a href="https://www.linkedin.com/in/pedro-andre-arroyo-silva/" target="_blank">Pedro Arroyo</a>
        <span class="sr-only"> (opens in new tab)</span>
        <br>
        <small>Generated: 2026-02-19</small>
      </p>
    </div>
  </div>
</header>

<main class="main-content">
  <div class="container">
    <section class="filters-section" aria-label="Job filters">
      <div class="filters-header">
        <h2 class="filters-title">
          <i class="fas fa-filter"></i>
          Filter Opportunities
        </h2>
        <div class="filters-actions">
          <button class="btn btn-secondary btn-sm" id="resetBtn" type="button">
            <i class="fas fa-refresh"></i>
            Reset All
          </button>
        </div>
      </div>

      <div class="filters-bar">
        <div class="filter-item">
          <label class="filter-label" for="titleInput"><i class="fas fa-search"></i> Job Title Keywords</label>
          <input type="text" id="titleInput" class="filter-input" placeholder="e.g., Software Engineer, Product Manager">
          <div class="selected-tags" id="titleTags"></div>
        </div>

        <div class="filter-item">
          <label class="filter-label" for="companyInput"><i class="fas fa-building"></i> Company</label>
          <input type="text" id="companyInput" class="filter-input" placeholder="Click to select companies..." readonly>
          <div class="selected-tags" id="companyTags"></div>
          <div class="dropdown" id="companyDropdown">
            <div class="dropdown-header">
              <input type="text" class="dropdown-search" id="companySearch" placeholder="Search companies...">
            </div>
            <div class="dropdown-list" id="companyList"></div>
          </div>
        </div>

        <div class="filter-item">
          <label class="filter-label" for="locationInput"><i class="fas fa-map-marker-alt"></i> Location</label>
          <input type="text" id="locationInput" class="filter-input" placeholder="Click to select locations..." readonly>
          <div class="selected-tags" id="locationTags"></div>
          <div class="dropdown" id="locationDropdown">
            <div class="dropdown-header">
              <input type="text" class="dropdown-search" id="locationSearch" placeholder="Search locations...">
            </div>
            <div class="dropdown-list" id="locationList"></div>
          </div>
        </div>

        <div class="filter-item">
          <label class="filter-label" for="seniorityInput"><i class="fas fa-layer-group"></i> Seniority Level</label>
          <input type="text" id="seniorityInput" class="filter-input" placeholder="Click to select levels..." readonly>
          <div class="selected-tags" id="seniorityTags"></div>
          <div class="dropdown" id="seniorityDropdown">
            <div class="dropdown-header">
              <input type="text" class="dropdown-search" id="senioritySearch" placeholder="Search levels...">
            </div>
            <div class="dropdown-list" id="seniorityList"></div>
          </div>
        </div>

        <div class="filter-item">
          <label class="filter-label" for="postedInput"><i class="fas fa-calendar"></i> Posted Date</label>
          <input type="text" id="postedInput" class="filter-input" placeholder="Click to select dates..." readonly>
          <div class="selected-tags" id="postedTags"></div>
          <div class="dropdown" id="postedDropdown">
            <div class="dropdown-header">
              <input type="text" class="dropdown-search" id="postedSearch" placeholder="Search dates...">
            </div>
            <div class="dropdown-list" id="postedList"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="results-section" aria-label="Job listings">
      <div class="results-header">
        <div class="results-count">
          <i class="fas fa-list"></i>
          <span id="resultCount">Loading opportunities...</span>
        </div>
      </div>

      <div class="table-container">
        <table id="jobsTable" role="table" aria-label="Job opportunities">
          <thead>
            <tr>
              <th>#</th>
              <th>Position</th>
              <th>Company</th>
              <th>Location</th>
              <th>Seniority</th>
              <th>Posted</th>
              <th>Apply</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="load-more-container">
        <button id="loadMoreBtn" class="btn" style="display:none;">
          <i class="fas fa-plus"></i>
          Load More Opportunities
        </button>
      </div>
    </section>
  </div>
</main>

<div id="loadingIndicator" style="display:none; text-align:center; padding:40px;">
  <div class="spinner"></div>
  Loading opportunities...
</div>

<script>
  const DATA_BASE = "app";

  let JOBS = [];
  let OPTIONS = { company: [], seniority: [], location: [], posted: [] };
  let OPTION_COUNTS = { company: {}, seniority: {}, location: {}, posted: {} };
  let META = null;

  let debounceTimer;
  let filteredJobs = [];
  let visibleCount = 0;
  const batchSize = 50;

  const selected = {
    title: new Set(),
    company: new Set(),
    seniority: new Set(),
    location: new Set(),
    posted: new Set()
  };

  const filterConfig = [
    { key: 'title', label: 'Title Keywords', type: 'text' },
    { key: 'company', label: 'Company', type: 'multiselect' },
    { key: 'location', label: 'Location', type: 'multiselect' },
    { key: 'seniority', label: 'Seniority', type: 'multiselect' },
    { key: 'posted', label: 'Posted Date', type: 'multiselect' }
  ];

  async function fetchJson(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`Failed to load ${url}: ${res.status}`);
    return await res.json();
  }

  async function bootstrapData() {
    const [jobs, options, counts, meta] = await Promise.all([
      fetchJson(`./${DATA_BASE}.jobs.json`),
      fetchJson(`./${DATA_BASE}.options.json`),
      fetchJson(`./${DATA_BASE}.counts.json`),
      fetchJson(`./${DATA_BASE}.meta.json`)
    ]);

    JOBS = jobs || [];
    OPTIONS = options || OPTIONS;
    OPTION_COUNTS = counts || OPTION_COUNTS;
    META = meta || null;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function debounce(func, wait) {
    return function (...args) {
      const later = () => {
        clearTimeout(debounceTimer);
        func(...args);
      };
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(later, wait);
    };
  }

  function updateTags(filterKey) {
    const tagsDiv = document.getElementById(filterKey + 'Tags');
    if (!tagsDiv) return;
    tagsDiv.innerHTML = '';

    (selected[filterKey] || new Set()).forEach(value => {
      const tag = document.createElement('span');
      tag.className = 'selected-tag';

      const text = document.createElement('span');
      text.textContent = value;

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove';
      removeBtn.textContent = '×';
      removeBtn.dataset.key = filterKey;
      removeBtn.dataset.value = value; // RAW VALUE (no escaping)

      tag.appendChild(text);
      tag.appendChild(removeBtn);
      tagsDiv.appendChild(tag);
    });
  }

  function removeTag(filterKey, value) {
    if (!selected[filterKey]) return;
    selected[filterKey].delete(value);
    updateTags(filterKey);
    filterJobs();
  }

  function createDropdown(filterKey) {
    const input = document.getElementById(filterKey + 'Input');
    const dropdown = document.getElementById(filterKey + 'Dropdown');
    const list = document.getElementById(filterKey + 'List');
    const search = document.getElementById(filterKey + 'Search');

    if (!input || !dropdown || !list) return;

    function populateList(items = OPTIONS[filterKey] || []) {
      list.innerHTML = '';
      items.forEach(item => {
        const listItem = document.createElement('div');
        listItem.className = 'dropdown-item';
        listItem.dataset.value = item;
        const jobCount = OPTION_COUNTS[filterKey]?.[item] || 0;
        listItem.innerHTML = `
          <div class="checkbox">${selected[filterKey].has(item) ? '✓' : ''}</div>
          <div class="item-text">${escapeHtml(item)}</div>
          <div class="item-count">(${jobCount})</div>
        `;
        listItem.addEventListener('click', () => {
          if (selected[filterKey].has(item)) selected[filterKey].delete(item);
          else selected[filterKey].add(item);
          updateTags(filterKey);
          populateList();
          filterJobs();
        });
        list.appendChild(listItem);
      });
    }

    function searchItems() {
      const query = (search?.value || '').toLowerCase().trim();
      const filtered = (OPTIONS[filterKey] || []).filter(item =>
        item.toLowerCase().includes(query)
      );
      populateList(filtered);
    }

    input.addEventListener('click', () => {
      dropdown.classList.toggle('show');
      if (dropdown.classList.contains('show')) {
        populateList();
        if (search) search.focus();
      }
    });

    if (search) search.addEventListener('input', debounce(searchItems, 200));

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.filter-item')) dropdown.classList.remove('show');
    });

    populateList();
  }

    function norm(s) {
      return (s || "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

  function showPostedDetails(postedElement, postedData) {
    const existing = document.querySelector('.posted-expanded.show');
    if (existing) existing.remove();
    if (!postedData || !postedData.display) return;

    const expanded = document.createElement('div');
    expanded.className = 'posted-expanded';
    expanded.innerHTML = `
      <div><strong>Posted:</strong> ${escapeHtml(postedData.display)}</div>
      <div><strong>Date:</strong> ${escapeHtml(postedData.date || 'Unknown')}</div>
      <div><strong>Days ago:</strong> ${postedData.days_ago === 'Unknown' ? 'Unknown' : (postedData.days_ago + ' days')}</div>
    `;
    postedElement.style.position = 'relative';
    postedElement.appendChild(expanded);

    setTimeout(() => {
      expanded.classList.add('show');
      const closeExpanded = (e) => {
        if (!postedElement.contains(e.target)) {
          expanded.remove();
          document.removeEventListener('click', closeExpanded);
        }
      };
      setTimeout(() => document.addEventListener('click', closeExpanded), 50);
    }, 10);
  }

    function parseQuery(input) {
      const s = (input || "").trim().toLowerCase();
      const phrases = [...s.matchAll(/"([^"]+)"/g)].map(m => m[1]);
      const leftover = s.replace(/"[^"]+"/g, " ");
      const words = leftover.split(/\s+/).filter(Boolean);
      return { phrases, words };
    }



  function filterJobs() {
    const titleInput = (document.getElementById('titleInput')?.value || '').toLowerCase().trim();
    const q = norm(document.getElementById('titleInput')?.value || "");
    const titleKeywords = q ? q.split(" ") : [];

    filteredJobs = JOBS.filter(job => {
      const { phrases, words } = parseQuery(document.getElementById('titleInput')?.value || "");
      const title = norm(job.title || "");
      const matchesTitle =
          (phrases.length === 0 || phrases.every(p => title.includes(norm(p)))) &&
          (words.length === 0 || words.every(w => title.includes(norm(w))));

      const matchesCompany = selected.company.size === 0 || selected.company.has(job.company);

      const jobLocations = job.location_flat || [];
      const matchesLocation =
        selected.location.size === 0 ||
        selected.location.has(job.location) ||
        jobLocations.some(loc => selected.location.has(loc));

      const matchesSeniority = selected.seniority.size === 0 || selected.seniority.has(job.seniority_pretty);
      const matchesPosted = selected.posted.size === 0 || selected.posted.has(job.posted_date);

      return matchesTitle && matchesCompany && matchesLocation && matchesSeniority && matchesPosted;
    });

    visibleCount = 0;
    document.getElementById('tableBody').innerHTML = '';
    renderBatch();
  }

  function createJobRow(job, index) {
    const row = document.createElement('tr');
    row.className = 'fade-in';

    const postedData = job.posted_processed || {};
    const isRecent = postedData.is_recent || false;
    const postedClass = isRecent
      ? 'posted recent'
      : ((postedData.days_ago && postedData.days_ago !== 'Unknown' && postedData.days_ago > 30) ? 'posted old' : 'posted');

    row.innerHTML = `
      <td>${index}</td>
      <td><div class="job-title">${escapeHtml(job.title || '')}</div></td>
      <td><strong>${escapeHtml(job.company || '')}</strong></td>
      <td><i class="fas fa-map-marker-alt" style="color: var(--text-muted); margin-right: 4px;"></i>${escapeHtml(job.location || '')}</td>
      <td><span class="meta-tag"><i class="fas fa-layer-group"></i> ${escapeHtml(job.seniority_pretty || 'Not specified')}</span></td>
      <td>
        <span class="meta-tag ${postedClass}">
          <i class="fas fa-calendar"></i> ${escapeHtml(postedData.display || job.posted_date || 'Unknown')}
        </span>
      </td>
      <td>
        <a href="${job.link}"
           target="_blank"
           rel="noopener noreferrer"
           class="apply-link">
          <i class="fas fa-external-link-alt"></i> Apply Now
        </a>
      </td>
    `;

    const postedElement = row.querySelector('.meta-tag.posted');
    if (postedElement && postedData.display) {
      postedElement.addEventListener('click', (e) => {
        e.stopPropagation();
        showPostedDetails(postedElement, postedData);
      });
    }

    // ✅ GA4 apply tracking (single source of truth)
    const applyLink = row.querySelector('a.apply-link');
    if (applyLink) {
      applyLink.addEventListener('click', () => {
        if (typeof gtag === 'function') {
          gtag('event', 'apply_click', {
            job_title: job.title || '',
            company: job.company || '',
            job_location: job.location || '',
            seniority: job.seniority_pretty || '',
            posted_date: job.posted_date || '',
            job_url: job.link || ''
          });
        }
      });
    }

    return row;
  }

  function renderBatch() {
    const tbody = document.getElementById('tableBody');
    const start = visibleCount;
    const end = Math.min(visibleCount + batchSize, filteredJobs.length);

    if (start >= filteredJobs.length) {
      document.getElementById('loadMoreBtn').style.display = 'none';
      return;
    }

    const fragment = document.createDocumentFragment();
    for (let i = start; i < end; i++) {
      fragment.appendChild(createJobRow(filteredJobs[i], i + 1));
    }
    tbody.appendChild(fragment);
    visibleCount = end;

    const resultCount = document.getElementById('resultCount');
    if (filteredJobs.length === 0) {
      resultCount.textContent = 'No opportunities found';
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="no-results">
            <i class="fas fa-search"></i>
            <h3>No opportunities found</h3>
            <p>Try adjusting your filters to see more results</p>
          </td>
        </tr>
      `;
    } else {
      resultCount.innerHTML = `<i class="fas fa-list"></i> Showing ${visibleCount} of ${filteredJobs.length} opportunities`;
    }

    const loadMoreBtn = document.getElementById('loadMoreBtn');
    loadMoreBtn.style.display = visibleCount < filteredJobs.length ? 'inline-flex' : 'none';
  }

  function loadMore() {
    document.getElementById('loadingIndicator').style.display = 'block';
    document.getElementById('loadMoreBtn').style.display = 'none';
    setTimeout(() => {
      renderBatch();
      document.getElementById('loadingIndicator').style.display = 'none';
    }, 200);
  }

  function resetFilters() {
    filterConfig.forEach(cfg => {
      const input = document.getElementById(cfg.key + 'Input');
      if (input) input.value = '';
    });

    Object.keys(selected).forEach(k => {
      selected[k].clear();
      updateTags(k);
    });

    filterJobs();
  }

  function updateHeaderStats() {
    const totalJobs = (META && META.total_jobs) ? META.total_jobs : JOBS.length;
    const totalCompanies = (META && META.total_companies) ? META.total_companies : (OPTIONS.company?.length || 0);
    const totalLocations = (META && META.total_locations) ? META.total_locations : (OPTIONS.location?.length || 0);

    document.getElementById("statTotalJobs").textContent = totalJobs.toLocaleString();
    document.getElementById("statCompanies").textContent = (totalCompanies || 0).toLocaleString() + "+";
    document.getElementById("statLocations").textContent = (totalLocations || 0).toLocaleString() + "+";
  }

  function initializeApp() {
    filterConfig.forEach(cfg => {
      if (cfg.type === 'multiselect') createDropdown(cfg.key);
    });

    updateHeaderStats();
    filteredJobs = JOBS.slice();
    visibleCount = 0;
    filterJobs();
  }

  document.addEventListener('DOMContentLoaded', () => {
    (async () => {
      try {
        await bootstrapData();
        initializeApp();
      } catch (err) {
        console.error(err);
        const rc = document.getElementById("resultCount");
        if (rc) rc.textContent = "Failed to load JSON data files (check GitHub Pages path).";
      }

      document.getElementById('loadMoreBtn')?.addEventListener('click', loadMore);
      document.getElementById('resetBtn')?.addEventListener('click', resetFilters);

      document.getElementById('titleInput')?.addEventListener('input', debounce(filterJobs, 300));

      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove')) {
          removeTag(e.target.dataset.key, e.target.dataset.value);
        }
      });

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
          document.querySelectorAll('.posted-expanded').forEach(x => x.remove());
        }
      });
    })();
  });
</script>

</body>
</html>